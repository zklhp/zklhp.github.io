<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个Emacs爱好者的个人网站."><title>Bandwagon上的Nginx升级到主线版本并添加HTTPS支持 | M-x Chris-An-Emacser</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdnjs.loli.net/ajax/libs/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.loli.net/ajax/libs/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.loli.net/ajax/libs/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.4.0/jquery.min.js"></script><script>window.jQuery||(document.write(decodeURI('%3Cscript src="/js/jquery.min.js" type="text/javascript"%3E%3C/script%3E')),document.write('<link rel="stylesheet" type="text/css" href="/css/normalize.min.css"/>'),document.write('<link rel="stylesheet" type="text/css" href="/css/pure-min.css"/>'),document.write('<link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/>'),document.write('<link rel="stylesheet" href="/css/font-awesome.min.css"/>'))</script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="amphtml" href="./amp/index.html"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Bandwagon上的Nginx升级到主线版本并添加HTTPS支持</h1><a id="logo" href="/.">M-x Chris-An-Emacser</a><p class="description">一个Emacs爱好者的闲言碎语</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home">首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/categories/"><i class="fa fa-folder"> 分类</i></a><a href="https://chriszheng.gitee.io/"><i class="fa fa-user"> 国内镜像站</i></a><a href="/essentials-of-academic-writing/"><i class="fa fa-book"> 学术写作指要</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Bandwagon上的Nginx升级到主线版本并添加HTTPS支持</h1><div class="post-meta">Jun 11, 2016<span> | </span><span class="category"><a href="/categories/VPS/">VPS</a></span><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/" href="/2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/#disqus_thread"></a><div class="post-content"><p>2016-7-13 更新了一下，现在是评分是A+了。</p><p><img src="/img/Qualys-SSL-Lab-A-Plus.png" alt="SSL Lab的评分"></p><h2 id="楔子">楔子</h2><p>Debian的一个不好的地方是官方仓库里的软件版本都好老，对于我这个激进人士来说不好😕。正好看了<a href="http://zilongshanren.com/blog/2016-06-08-embrace-https-and-http2.html" target="_blank" rel="noopener">子龙山人安利HTTPS</a>的帖子，觉得里面说的不用HTTPS的原因就是我一直以来不愿意搞的借口。痛定思痛，立马折腾。</p><a id="more"></a><h2 id="debian上安装主线版本的nginx">Debian上安装主线版本的Nginx</h2><p>所用的命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移除已经安装的nginx。</span></span><br><span class="line">apt-get purge nginx</span><br><span class="line">apt-get autoremove</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加nginx官方的Debian仓库，这里有主线版本，针对的是Debian的Jessie (8.x)。</span></span><br><span class="line">(cat &lt;&lt;-SRC</span><br><span class="line"><span class="comment"># nginx mainline repository</span></span><br><span class="line">deb http://nginx.org/packages/mainline/debian/ jessie nginx</span><br><span class="line">deb-src http://nginx.org/packages/mainline/debian/ jessie nginx</span><br><span class="line">SRC</span><br><span class="line">) &gt; /etc/apt/sources.list.d/nginx-mainline.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加key。</span></span><br><span class="line">wget http://nginx.org/keys/nginx_signing.key</span><br><span class="line">apt-key add nginx_signing.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Nginx。</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure><p>方法来自<a href="https://gist.github.com/hpherzog/8824136" target="_blank" rel="noopener">这里</a>，命令做了修改。</p><h2 id="添加https支持">添加HTTPS支持</h2><p>首先，<a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04" target="_blank" rel="noopener">教程</a>里面推荐的letsencrypt在我的VPS上无法安装，表现是运行了安装命令后CPU和内存占用飞涨，然后报错，有几次VPS直接关机了。搜索了一下，在<a href="https://segmentfault.com/a/1190000004457037" target="_blank" rel="noopener">这里</a>发现了<a href="https://github.com/diafygi/acme-tiny" target="_blank" rel="noopener">acme-tiny</a>，就用它了。配置HTTPS可以分为准备工作、申请证书、 安装证书和定时更新。</p><h3 id="准备工作">准备工作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装acme-tiny</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/diafygi/acme-tiny.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建存放证书的文件夹</span></span><br><span class="line">mkdir -p /www/certs/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立Let's Encrypt账户的私钥</span></span><br><span class="line">openssl genrsa 4096 &gt; /www/certs/account.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成域名的私钥</span></span><br><span class="line">openssl genrsa 4096 &gt; /www/certs/domain.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成域名的私钥</span></span><br><span class="line"><span class="comment"># 下面一行是针对单一域名的，如果你像我一样同时用带www和不带www的，需要用后面的那个。</span></span><br><span class="line"><span class="comment"># openssl req -new -sha256 -key domain.key -subj "/CN=chriszheng.science" &gt; /www/certs/domain.csr</span></span><br><span class="line"><span class="comment"># 这是对多个域名的</span></span><br><span class="line">openssl req -new -sha256 -key /www/certs/domain.key -subj <span class="string">"/"</span> -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(<span class="built_in">printf</span> <span class="string">"[SAN]\nsubjectAltName=DNS:chriszheng.science,DNS:www.chriszheng.science"</span>)) &gt; /www/certs/domain.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建用于验证域名的challenges文件夹</span></span><br><span class="line">mkdir -p /www/challenges/</span><br></pre></td></tr></table></figure><p>Nginx需要相关的配置，这块我不是很熟悉，而且自己也弄不好，只能贴出来我的配置跟各位分享了：</p><p><strong>Update</strong>:</p><p>后来发现我根本就不懂Nginx的配置方法，纯粹是瞎写的。challenge的目的是为了验证域名的所有权，需要保证网站里的<code>/.well-known/acme-challenge/</code>下的文件是可以访问的，也就是说<br><a href="http://chriszheng.science/.well-known/acme-challenge/wSMr1m2H9yXUxehaho3YT_G7ysSc6G3uz7JZgHocgdo">http://chriszheng.science/.well-known/acme-challenge/wSMr1m2H9yXUxehaho3YT_G7ysSc6G3uz7JZgHocgdo</a><br>是可以访问到的。我犯的错误是不懂<a href="http://www.wkii.org/nginx-set-directory-alias-and-root.html" target="_blank" rel="noopener">alias和root的区别</a>。最初的写法写了一个<code>root /www/challenges/;</code>，这样的话Nginx会去<code>/www/challenges/</code><strong>目录里</strong>找<code>/.well-known/acme-challenge/</code>，就是说找<code>/www/challenges/.well-known/acme-challenge/</code>，这明显不对，而应该用<code>alias</code>。从上面的连接也学到了<code>root</code>可以不写最后的<code>/</code>而<code>alias</code>必须写，这点也算是它们的区别了。修改后的代码是这样的：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">listen</span> [::]:<span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> /.well-known/acme-challenge/ &#123;</span><br><span class="line">		<span class="attribute">default_type</span> <span class="string">"text/plain"</span>;</span><br><span class="line">		<span class="attribute">alias</span> /www/challenges/;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># location / &#123;</span></span><br><span class="line">	<span class="comment"># 	return 301 https://$host$request_uri;</span></span><br><span class="line">	<span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后三行注释掉的内容在配置好了之后可以取消注释，那是用来将HTTP重定向到HTTPS的。</p><h3 id="开始申请">开始申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ./acme-tiny/acme_tiny.py --account-key /www/certs/account.key --csr /www/certs/domain.csr --acme-dir /www/challenges/ &gt; /tmp/signed.crt</span><br></pre></td></tr></table></figure><p>需要注意的是申请证书是有<a href="https://letsencrypt.org/docs/rate-limits/" target="_blank" rel="noopener"><strong>次数限制</strong></a>的，每周对同一个域名最多只能申请5次证书。</p><p><strong>Update</strong>:</p><p>解决了上面的问题下面的步骤已经不需要了。</p><p><s>在我的VPS上，可能是配置问题，这一步总会出现无法验证域名的问题，广泛查找资料也无解，所以我就把<code>acme_tiny.py</code>里相关的代码注释了。</s></p><h3 id="安装证书">安装证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem &gt; /tmp/intermediate.pem</span><br><span class="line">cat /tmp/signed.crt /tmp/intermediate.pem &gt; /www/certs/chained.pem</span><br><span class="line">wget -O - https://letsencrypt.org/certs/isrgrootx1.pem https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem https://letsencrypt.org/certs/letsencryptauthorityx1.pem https://www.identrust.com/certificates/trustid/root-download-x3.html | tee -a /www/certs/ca-certs.pem&gt; /dev/null</span><br></pre></td></tr></table></figure><p><strong>Update</strong>:</p><p>这里需要解释一下。前两行是获取了letsencrypt的交叉签名的证书，以前我弄了一个x1的，似乎不对，后面一行代码来自<a href="http://unix.stackexchange.com/questions/259430/let-encrypt-nginx-ocsp-stapling" target="_blank" rel="noopener">这里</a>，好像是用于OCSP stapling的。</p><p>Nginx的配置也需要修改，我现在用的是下面的样子，这个参考了很多配置但我也不是很懂😾：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">	<span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">server_name</span> chriszheng.science www.chriszheng.science;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">ssl_certificate</span> /www/certs/chained.pem;</span><br><span class="line">	<span class="attribute">ssl_certificate_key</span> /www/certs/domain.key;</span><br><span class="line">	<span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">	<span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">50m</span>;</span><br><span class="line">	<span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits.</span></span><br><span class="line">	<span class="attribute">ssl_dhparam</span> /etc/ssl/certs/dhparam.pem;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">	<span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">ssl_ciphers</span> <span class="string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA'</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)</span></span><br><span class="line">	<span class="attribute">add_header</span> Strict-Transport-Security max-age=<span class="number">15768000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># OCSP Stapling ---</span></span><br><span class="line">	<span class="comment"># fetch OCSP records from URL in ssl_certificate and cache them</span></span><br><span class="line">	<span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">## verify chain of trust of OCSP response using Root CA and Intermediate certs</span></span><br><span class="line">	<span class="attribute">ssl_trusted_certificate</span> /www/certs/ca-certs.pem;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">root</span> /www/hexo;</span><br><span class="line">	<span class="attribute">index</span> index.html index.htm;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">		<span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line">		<span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line">		<span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">		<span class="attribute">expires</span> <span class="number">1h</span>;</span><br><span class="line">		<span class="comment"># Uncomment to enable naxsi on this location</span></span><br><span class="line">		<span class="comment"># include /etc/nginx/naxsi.rules</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">listen</span> [::]:<span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> /.well-known/acme-challenge/ &#123;</span><br><span class="line">		<span class="attribute">default_type</span> <span class="string">"text/plain"</span>;</span><br><span class="line">		<span class="attribute">alias</span> /www/challenges/;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure><h3 id="自动化脚本">自动化脚本</h3><p>新建<code>/etc/cron.monthly/renew_cert</code>内容为：</p><p>2017-1-11 <strong>Update</strong>: 注意，cron的脚本不能加后缀，否则不执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">openssl genrsa 4096 &gt; /www/certs/domain.key</span><br><span class="line">openssl req -new -sha256 -key /www/certs/domain.key -subj <span class="string">"/"</span> -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(<span class="built_in">printf</span> <span class="string">"[SAN]\nsubjectAltName=DNS:chriszheng.science,DNS:www.chriszheng.science"</span>)) &gt; /www/certs/domain.csr</span><br><span class="line">python /root/acme-tiny/acme_tiny.py --account-key /www/certs/account.key --csr /www/certs/domain.csr --acme-dir /www/challenges/ &gt; /tmp/signed.crt || <span class="built_in">exit</span></span><br><span class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem &gt; /tmp/intermediate.pem</span><br><span class="line">cat /tmp/signed.crt /tmp/intermediate.pem &gt; /www/certs/chained.pem</span><br><span class="line">wget -O - https://letsencrypt.org/certs/isrgrootx1.pem https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem https://letsencrypt.org/certs/letsencryptauthorityx1.pem https://www.identrust.com/certificates/trustid/root-download-x3.html | tee -a /www/certs/ca-certs.pem&gt; /dev/null</span><br><span class="line">service nginx reload</span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h2 id="问题和解决方案">问题和解决方案</h2><h3 id="兼容性">兼容性</h3><p>用现在的配置基本就抛弃了WinXP+IE6的用户，这种用户基本不会访问我的网站，问题不大。</p><h3 id="混合内容">混合内容</h3><p>全站HTTPS要求所用的CDN也支持HTTPS，国内的CDN很多不支持，所以我把一些资源变成了本地的。</p><p>在写法上，要把<code>http://cdn.bootcss.com</code>变成<code>//cdn.bootcss.com</code>，就是和当前站的协议一样，如果所用的CDN也支持HTTPS就不会出错了。</p><h3 id="第三方服务">第三方服务</h3><p>对于我的静态站来说，第三方服务比如Disqus的需要做相应的设置和迁移。</p><p><strong>Update</strong>: Disqus搞的不好，我的很多评论的<a href="https://disqus.com/home/discussion/channel-discussdisqus/how_to_fix_wrong_urls/" target="_blank" rel="noopener">URL坏了</a>，还不能改，肯定是他们的系统有问题。</p><h3 id="不能通过ip访问网站">不能通过IP访问网站</h3><p>这是一个缺陷，浏览器会提示不安全。</p><p><strong>Update</strong>:</p><h3 id="搜索效果变差">搜索效果变差</h3><p>谷歌骗我，我今天看了一下，发现展现量和访问量都变低了。</p><p><strong>Update</strong>:</p><p>我似乎明白了，变低是因为流量都重定向到HTTPS的站上了，将那个站也添加到谷歌里面就好了。</p><h2 id="结语">结语</h2><p>虽然折腾上了，还是有很多不懂，只能先用起来再慢慢学习和完善。感谢无数的「先行者」不停的晓之以理，动之以情的宣传HTTPS打消了我的顾虑。贴吧的<a href="https://anglesya.win/" target="_blank" rel="noopener">雅丶涵</a>一直在<a href="http://tieba.baidu.com/p/4667399187" target="_blank" rel="noopener">普及证书知识</a>，在此表示感谢。</p><p>当然，最要感谢的是<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>。</p></div><ul class="post-copyright"><li><strong>本文作者</strong>：<a href="https://chriszheng.science/">Chris</a></li><li><strong>本文链接</strong>：<a href="https://chriszheng.science/2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/">https://chriszheng.science/2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/</a></li><li><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY 4.0</a> 许可协议。转载请注明出处！</li></ul><iframe src="/donate/?AliPayQR=/img/My-AliPayQR.png&amp;WeChatQR=/img/My-WeChatQR.png&amp;GitHub=https://github.com/zklhp/&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=https://paypal.me/ChrisZheng99" style="overflow-x:hidden;overflow-y:hidden;border:0xp none #fff;min-height:240px;width:100%" frameborder="0" scrolling="no"></iframe><script type="text/javascript">!function(h){h("body").on("click",function(){h(".article-share-box.on").removeClass("on")}).on("click",".article-share-link",function(e){e.stopPropagation();var t=h(this),a=t.attr("data-url"),i=t.attr("data-qrcode"),r=encodeURIComponent(a),o="article-share-box-"+t.attr("data-id"),s=document.title,c=t.offset();if(h("#"+o).length){if((n=h("#"+o)).hasClass("on"))return void n.removeClass("on")}else{var l=['<div id="'+o+'" class="article-share-box">','<input class="article-share-input" value="'+a+'">','<div class="article-share-links">','<a href="//twitter.com/intent/tweet?url='+r+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="//www.facebook.com/sharer.php?u='+r+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="//service.weibo.com/share/share.php?title='+s+"&url="+r+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="Weibo"></a>','<a href="'+i+'" class="article-share-qrcode" target="_blank" title="QR code"></a>','<div class="qrcode"><img src='+i+"></div>","</div>","</div>"].join(""),n=h(l);h("body").append(n)}h(".article-share-box.on").hide(),n.css({top:c.top+25,left:c.left}).addClass("on")}).on("click",".article-share-box",function(e){e.stopPropagation()}).on("click",".article-share-box-input",function(){h(this).select()}).on("click",".article-share-box-link",function(e){e.preventDefault(),e.stopPropagation(),window.open(this.href,"article-share-box-window-"+Date.now(),"width=500,height=450")})}(jQuery)</script><a class="article-share-link" data-url="https://chriszheng.science/2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/" data-id="cjzu3h6sv0018bgbpbsmisl2l" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACxUlEQVR42u3aS27DMAwFQN//0ummixSolUdSar0Yr4J8ZI0LiCzJ64qv19t19877++tf3a18d939dtuFh4eHN9j6eum7GyTfv/t0fd9k/fVv8fDw8M7x7jZd3dx6nfz0TvYQ3QsPDw/vAbz8xmvYLjYeHh7e83l5MEhS5OQu/xz38PDw8AbFiPVCk8JuXuo9WGvBw8PDq1UMoi7Sc14f6e/h4eHhjbvqeTMsP/qrjbHePr9/i4eHh3eANymnzh9E72yvDofh4eHh7eWNDtxiQ2v+d0gCxo+d4OHh4R3j5dtd3yxPiydjBEnhuPC88fDw8Iq8vGhbbVPlxYhJwaIXcvDw8PDmvGqxIPl+dYxgEqKu+Xbx8PDwWrxJ26kHS173Wmu/VKnx8PDwtvLyU7S6aLUYkd+9V87Aw8PDm/N6h3j1iO8NJfQKGXh4eHinefMEd5IKJ1FrkqDj4eHhnePljflekTffyq40/cPfEA8PD2/AmxzH8+Gt3oMrNMPw8PDwDvAmx3qvlNADTAIJHh4e3glectRWW1l54NkVbG73hoeHh7eVVz30e438PIHOCw1REMLDw8M7wFsvmi89DypJ2t0MJHh4eHhbedX0t1dgzQdV1yWG6gp4eHh4J3i91Dn5frL1K756aT0eHh7eOV7ebZ8MFlTT8XzsdfT48PDw8Fq8XQ3+JBVOUud8rKEcVfDw8PAO8PYm3NX1J6XeD1VqPDw8vAO8XsZdaOG3AtK8bIGHh4e3l/cqXvMMttpsq441/NLfw8PDw9vK6x241QJur4SRJO4bGmB4eHh4m0YH5gd0XlDIj/jqynh4eHineZOGU7XokISWahJf/hgPDw/vD3m7xrB62W85vcbDw8N7AG8eHqqjCQk+Gh3Aw8PD28pLihHJO9Wt94ZWC8MKeHh4eAd483/4k4eSPKBqOOkVL/Dw8PAGvC+TKn2C+vvWPwAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Bandwagon/">Bandwagon</a><a href="/tags/Nginx/">Nginx</a></div><div class="post-nav"><a class="pre" href="/2016/06/16/EmojiOne-Color/">EmojiOne Color——一个支持全彩Emoji的字体</a><a class="next" href="/2016/06/10/Generate-random-sentences-in-MS-Word/">在Word中生成随机的文字</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://chriszheng.science/2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/",this.page.identifier="2016/06/11/Bandwagon-Nginx-meanline-and-HTTPS/",this.page.title="Bandwagon上的Nginx升级到主线版本并添加HTTPS支持"}</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({url:"https://disqus.com/next/config.json",timeout:2500,type:"GET",success:function(){var s=document,e=s.createElement("script");e.src="//chris-an-emacser.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(s.head||s.body).appendChild(e),$(".disqus_click_btn").css("display","none")},error:function(){$(".disqus_click_btn").css("display","block")}})</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//chris-an-emacser.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function(){var n=new XMLHttpRequest;n.open("GET","//disqus.com/next/config.json",!0),n.timeout=2500,n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){$(".post-meta .post-comments-count").show();var t=document.createElement("script");t.id="dsq-count-scr",t.src="https://chris-an-emacser.disqus.com/count.js",t.async=!0,(document.head||document.body).appendChild(t)}},n.ontimeout=function(){n.abort()},n.send(null)})</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o">分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Emacs/">Emacs</a><span class="category-list-count">38</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Emacs小技巧/">Emacs小技巧</a><span class="category-list-count">50</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Firefox/">Firefox</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shadowsocks/">Shadowsocks</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/VPS/">VPS</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/一句话经验/">一句话经验</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分享/">分享</a><span class="category-list-count">44</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/名言分享/">名言分享</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/字体排印/">字体排印</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/摄影作品/">摄影作品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/文学作品/">文学作品</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/科学研究/">科学研究</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笑话段子/">笑话段子</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/经验分享/">经验分享</a><span class="category-list-count">41</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程技术/">编程技术</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网站信息/">网站信息</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/近思录/">近思录</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/闲言碎语/">闲言碎语</a><span class="category-list-count">49</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o">标签</i></div><div class="tagcloud"><a href="/tags/闲言碎语/" style="font-size:16.25px">闲言碎语</a> <a href="/tags/科研/" style="font-size:10px">科研</a> <a href="/tags/老司机/" style="font-size:10px">老司机</a> <a href="/tags/经验/" style="font-size:13.75px">经验</a> <a href="/tags/DNS/" style="font-size:10px">DNS</a> <a href="/tags/名人名言/" style="font-size:17.5px">名人名言</a> <a href="/tags/320-Kbps/" style="font-size:10px">320 Kbps</a> <a href="/tags/流量/" style="font-size:10px">流量</a> <a href="/tags/7zip/" style="font-size:10px">7zip</a> <a href="/tags/目录/" style="font-size:10px">目录</a> <a href="/tags/Mew/" style="font-size:11.25px">Mew</a> <a href="/tags/Emacs/" style="font-size:20px">Emacs</a> <a href="/tags/技巧/" style="font-size:15px">技巧</a> <a href="/tags/邮件/" style="font-size:10px">邮件</a> <a href="/tags/壁纸/" style="font-size:12.5px">壁纸</a> <a href="/tags/Org-mode/" style="font-size:11.25px">Org-mode</a> <a href="/tags/搞笑/" style="font-size:11.25px">搞笑</a> <a href="/tags/博客/" style="font-size:13.75px">博客</a> <a href="/tags/分享/" style="font-size:18.75px">分享</a> <a href="/tags/段子/" style="font-size:17.5px">段子</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link">友情链接</i></div><ul></ul><a href="https://bandwagonhost.com/aff.php?aff=3069" title="便宜好用的搬瓦工(含推广)" target="_blank">便宜好用的搬瓦工(含推广)</a><ul></ul><a href="http://www.vultr.com/?ref=7184966" title="支持小时收费的vultr (含推广)" target="_blank">支持小时收费的vultr (含推广)</a><ul></ul><a href="https://gitee.com/chriszheng/Blog" title="帖子的md文件" target="_blank">帖子的md文件</a><ul></ul><a href="https://gitee.com/chriszheng/dotEmacs" title="我的配置文件" target="_blank">我的配置文件</a><ul></ul><a href="https://chriszheng.science/" title="M-x Chris-An-Emacser" target="_blank">M-x Chris-An-Emacser</a><ul></ul><a href="http://chriszheng.oschina.io/" title="OSChina上的镜像" target="_blank">OSChina上的镜像</a><ul></ul><a href="http://chriszheng.gitee.io/" title="OSChina上的镜像" target="_blank">OSChina上的镜像</a><ul></ul><a href="https://zklhp.github.io/" title="GitHub上的镜像" target="_blank">GitHub上的镜像</a><ul></ul><a href="https://mastodon.sdf.org/@chriszheng" rel="me" title="@chriszheng@mastodon.sdf.org" target="_blank">@chriszheng@mastodon.sdf.org</a><ul></ul><a href="https://github.com/emacs-china/blogroll" title="emacs-china/blogroll" target="_blank">emacs-china/blogroll</a><ul></ul><a href="https://github.com/RSS-Renaissance/awesome-blogCN-feeds" title="优质的「独立中文博客」订阅列表" target="_blank">优质的「独立中文博客」订阅列表</a><ul></ul><a href="http://emacsist.com/" title="Emacsist" target="_blank">Emacsist</a><ul></ul><a href="http://jerry011235.github.io/" title="璀璨星空" target="_blank">璀璨星空</a><ul></ul><a href="http://www.geekplux.com/" title="GeekPlux" target="_blank">GeekPlux</a><ul></ul><a href="http://www.lijigang.com/" title="lijigang" target="_blank">lijigang</a><ul></ul><a href="http://zilongshanren.com/" title="子龙山人" target="_blank">子龙山人</a><ul></ul><a href="http://blog.lujun9972.win/" title="暗无天日" target="_blank">暗无天日</a><ul></ul><a href="http://kelvinh.github.io/" title="Kelvin的胡言乱语" target="_blank">Kelvin的胡言乱语</a><ul></ul><a href="http://emacs-china.org/" title="Emacs China" target="_blank">Emacs China</a><ul></ul><a href="https://tiexo.github.io/" title="简单可依赖" target="_blank">简单可依赖</a><ul></ul><a href="http://jetyu.me/" title="Jet’s Notes" target="_blank">Jet’s Notes</a><ul></ul><a href="http://bbs.keinsci.com/?fromuid=4772" title="计算化学公社(含推广)" target="_blank">计算化学公社(含推广)</a><ul></ul><a href="http://tieba.baidu.com/f?kw=firefox&amp;ie=utf-8" title="狐吧" target="_blank">狐吧</a><ul></ul><a href="https://chempeng.github.io/" title="Chem_peng" target="_blank">Chem_peng</a><ul></ul><a href="https://urzz.me/" title="瘫曲的Blog" target="_blank">瘫曲的Blog</a><ul></ul><a href="http://hongludianxue.com/" title="红炉点雪" target="_blank">红炉点雪</a><ul></ul><a href="https://macplay.github.io/" title="MacPlay" target="_blank">MacPlay</a><ul></ul><a href="https://lengyueyang.github.io/" title="深度识医" target="_blank">深度识医</a><ul></ul><a href="http://kevinjiang.info/" title="(power up)" target="_blank">(power up)</a><ul></ul><a href="https://www.jianshu.com/u/390b177189f0" title="QQ群友「七月流火」的Blog" target="_blank">QQ群友「七月流火」的Blog</a><ul></ul><a href="http://xiaoyan.work/" title="小焱" target="_blank">小焱</a><ul></ul><a href="http://sdf-cn.org/" title="SDF公众Unix服务器中文站" target="_blank">SDF公众Unix服务器中文站</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">M-x Chris-An-Emacser.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a> UV/PV: <span id="busuanzi_value_site_uv">| </span>/<span id="busuanzi_value_site_pv"> | </span>.</div></div></div><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript">$(document).ready(function(){$("img").each(function(){if(!$(this).parent().hasClass("fancybox")&&!$(this).hasClass("nofancybox")){var a=this.alt;a&&$(this).after('<span class="caption">'+a+"</span>"),$(this).wrap('<a href="'+(null==$(this).attr("data-src")?this.src:$(this).attr("data-src"))+'" title="'+a+'" class="fancybox"></a>')}}),$(this).find(".fancybox").each(function(){$(this).attr("rel","article")})}),$(document).ready(function(){$("a[href$='.jpg'],a[href$='.png'],a[href$='.gif'],a[href$='.webp']").attr("rel","gallery").fancybox({helpers:{title:{type:"inside"}}})})</script><link rel="stylesheet" type="text/css" href="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script>window.jQuery||(document.write(decodeURI('%3Cscript src="/js/jquery.fancybox.min.js" type="text/javascript"%3E%3C/script%3E')),document.write('<link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css">'))</script><script type="text/javascript">var searchFunc=function(t,a,i){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),n=document.getElementById(a),r=document.getElementById(i);n.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n=!0,r=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url,i=-1,s=-1,l=-1;if(""!=r&&""!=a&&m.forEach(function(t,e){i=r.indexOf(t),s=a.indexOf(t),i<0&&s<0?n=!1:(s<0&&(s=0),0==e&&(l=s))}),n){f+="<li><a href='"+e+"' class='search-result-title'>"+r+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-30,o=78;u<0&&(u=0),u+o>c.length&&(c.length<o?o=c.length-u:u=c.length-o);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",r.innerHTML=f)})}})}</script><script>var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;searchFunc(path,"local-search-input","local-search-result")</script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript">!function(r){"use strict";function i(i){this.$codeBlocks=r(i)}i.prototype={run:function(){var i=this;i.resize(),r(window).smartresize(function(){i.resize()})},resize:function(){this.$codeBlocks.each(function(){var i=r(this).find(".gutter"),t=r(this).find(".code"),n=t.width()-t.innerWidth(),e=r(this).outerWidth()-i.outerWidth()+n;t.css("width",e),t.children("pre").css("width",e)})}},r(document).ready(function(){r.fn.hasHorizontalScrollBar=function(){return this.get(0).scrollWidth>this.innerWidth()},new i("figure.highlight").run()})}(jQuery)</script><script type="text/javascript">!function(n,t){jQuery.fn[t]=function(n){return n?this.bind("resize",function(i,r,e){var u;return function(){var n=this,t=arguments;u?clearTimeout(u):e&&i.apply(n,t),u=setTimeout(function(){e||i.apply(n,t),u=null},r||100)}}(n)):this.trigger(t)}}(jQuery,"smartresize")</script><a class="show" id="rocket" href="#top"></a><script>$(window).scroll(function(){500<$(window).scrollTop()?$("#rocket").addClass("show"):$("#rocket").removeClass("show")}),$("#rocket").click(function(){return $("#rocket").addClass("launch"),$("html, body").animate({scrollTop:0},500,function(){$("#rocket").removeClass("show launch")}),!1})</script></div></body></html>